<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Fretboard Trainer</title>
    <style>
        :root {
            --bg-color: #121212;
            --board-color: #2a1f1b;
            --fret-wire: #b0b0b0;
            --string-color: #666;
            --highlight: #00e5ff; /* 青色高亮，冷峻 */
            --correct: #00e676;
            --wrong: #ff1744;
            --text-color: #eeeeee;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* --- Header / Controls --- */
        header {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            width: 100%;
            background: linear-gradient(to bottom, #1a1a1a, #0f0f0f);
            border-bottom: 1px solid #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }

        h1 { 
            margin: 0 0 12px 0; 
            font-weight: 300; 
            letter-spacing: 4px; 
            text-transform: uppercase; 
            font-size: 1rem; 
            color: #777;
        }

        .top-controls {
            display: flex;
            gap: 25px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap; /* 小屏幕自动换行 */
        }
        
        /* 计分板 */
        .stats { 
            font-size: 0.9rem; 
            color: #555; 
            font-family: monospace; 
            padding-right: 20px;
            border-right: 1px solid #333;
        }
        .stats span { margin: 0 5px; color: #aaa; font-weight: bold; }

        /* 下拉菜单 */
        select.string-select {
            background-color: #222;
            color: #ddd;
            border: 1px solid #444;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
            transition: border 0.2s;
        }
        select.string-select:hover { border-color: var(--highlight); }

        /* 开关样式 */
        .toggle-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .toggle-label {
            font-size: 0.85rem;
            margin-left: 10px;
            color: #888;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--highlight); }
        input:checked + .slider:before { transform: translateX(20px); }
        input:checked ~ .toggle-label { color: var(--highlight); }

        /* --- Fretboard --- */
        .fretboard-container {
            flex: 1;
            width: 98%;
            max-width: 1600px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .fretboard {
            width: 100%;
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            aspect-ratio: 18 / 3;
            background-color: var(--board-color);
            border-bottom: 3px solid #000;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            position: relative;
        }

        .fret-cell {
            position: relative;
            border-right: 2px solid var(--fret-wire);
            box-sizing: border-box;
        }
        
        .fret-cell.fret-0 {
            border-right: 5px solid #dcc090;
            background-color: #1a1a1a;
        }

        .string-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            background-color: var(--string-color);
            transform: translateY(-50%);
            z-index: 2;
            pointer-events: none;
        }

        /* String Thickness */
        .row-0 .string-line { height: 1px;  background-color: #888; }
        .row-1 .string-line { height: 1.5px; background-color: #888; }
        .row-2 .string-line { height: 2px; background-color: #888; }
        .row-3 .string-line { height: 2.5px; background-color: #777; }
        .row-4 .string-line { height: 3.5px; background-color: #777; }
        .row-5 .string-line { height: 4.5px; background-color: #777; }

        .marker {
            position: absolute;
            left: 50%;
            width: 14px;
            height: 14px;
            background-color: #d7ccc8;
            border-radius: 50%;
            opacity: 0.6;
            z-index: 1;
            transform: translate(-50%, -50%);
        }

        .marker.single { top: 100%; }
        .marker.double-top { top: 20%; }
        .marker.double-bottom { top: 80%; }

        /* Highlight */
        .target-dot {
            width: 18px; 
            height: 18px;
            background-color: var(--highlight);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 15px var(--highlight);
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: translate(-50%, -50%) scale(0.9); opacity: 0.8; }
            to { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        }

        .controls-area {
            flex: 0 0 auto;
            background-color: #1e1e1e;
            width: 100%;
            padding: 20px 0 40px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 1px solid #333;
        }

        .feedback {
            height: 40px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .note-buttons {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 6px;
            width: 95%;
            max-width: 1000px;
        }

        button.note-btn {
            background-color: #333;
            color: #ccc;
            border: 1px solid #444;
            padding: 12px 0;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s;
        }

        button.note-btn:hover { background-color: #555; color: #fff; }
        
        .next-btn {
            margin-top: 15px;
            background-color: var(--highlight);
            color: #000;
            border: none;
            padding: 8px 30px;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: none;
            font-weight: bold;
        }

        @media (max-width: 800px) {
            .note-buttons { grid-template-columns: repeat(6, 1fr); }
            .fretboard { aspect-ratio: auto; height: 180px; }
            .top-controls { gap: 15px; }
            h1 { font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Tactical Fretboard Trainer</h1>
        <div class="top-controls">
            <div class="stats">
                SCORE: <span id="score-correct" style="color:var(--correct)">0</span> / <span id="score-total">0</span>
            </div>
            
            <select id="string-selector" class="string-select" onchange="resetAndGenerate()">
                <option value="all">All Strings</option>
                <option value="0">1st String (High E)</option>
                <option value="1">2nd String (B)</option>
                <option value="2">3rd String (G)</option>
                <option value="3">4th String (D)</option>
                <option value="4">5th String (A)</option>
                <option value="5">6th String (Low E)</option>
            </select>

            <label class="toggle-container">
                <div class="switch">
                    <input type="checkbox" id="inlay-mode" onchange="resetAndGenerate()">
                    <span class="slider"></span>
                </div>
                <span class="toggle-label">ANCHOR MODE</span>
            </label>
        </div>
    </header>

    <div class="fretboard-container">
        <div class="fretboard" id="fretboard">
            </div>
    </div>

    <div class="controls-area">
        <div class="feedback" id="feedback-display"></div>
        
        <div class="note-buttons" id="note-buttons">
            </div>

        <button class="next-btn" id="next-btn" onclick="generateQuestion()">Next</button>
    </div>

    <script>
        const numStrings = 6;
        const numFrets = 22; 
        // Index 0 = High E (1st), Index 5 = Low E (6th)
        const stringTuning = ['E', 'B', 'G', 'D', 'A', 'E']; 
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const notesDisplay = {
            'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb'
        };
        const inlays = [3, 5, 7, 9, 12, 15, 17, 19, 21];

        let currentTarget = { stringIdx: 0, fretIdx: 0, note: '' };
        let correctCount = 0;
        let totalCount = 0;
        let isWaiting = false;

        const fretboardEl = document.getElementById('fretboard');
        const feedbackEl = document.getElementById('feedback-display');
        const nextBtn = document.getElementById('next-btn');
        const modeSwitch = document.getElementById('inlay-mode');
        const stringSelector = document.getElementById('string-selector');

        function init() {
            calculateFretWidths();
            renderFretboard();
            renderButtons();
            generateQuestion();
            window.addEventListener('resize', calculateFretWidths);
        }

        function resetAndGenerate() {
            generateQuestion();
        }

        function calculateFretWidths() {
            let columnsCSS = "0.6fr "; 
            let currentFr = 1.6; 
            for (let i = 1; i <= numFrets; i++) {
                columnsCSS += `${currentFr.toFixed(4)}fr `;
                currentFr = currentFr * 0.9438; 
            }
            fretboardEl.style.gridTemplateColumns = columnsCSS;
        }

        function renderFretboard() {
            fretboardEl.innerHTML = ''; 
            
            for (let s = 0; s < numStrings; s++) {
                for (let f = 0; f <= numFrets; f++) {
                    const cell = document.createElement('div');
                    cell.className = `fret-cell row-${s} fret-${f}`;
                    cell.dataset.string = s;
                    cell.dataset.fret = f;

                    const stringLine = document.createElement('div');
                    stringLine.className = 'string-line';
                    cell.appendChild(stringLine);

                    // Markers
                    if (inlays.includes(f) && f !== 12) {
                        if (s === 2) { 
                            const marker = document.createElement('div');
                            marker.className = 'marker single';
                            cell.appendChild(marker);
                        }
                    }
                    if (f === 12) {
                        if (s === 2) {
                            const m1 = document.createElement('div');
                            m1.className = 'marker double-top';
                            cell.appendChild(m1);
                        }
                        if (s === 3) {
                            const m2 = document.createElement('div');
                            m2.className = 'marker double-bottom';
                            cell.appendChild(m2);
                        }
                    }
                    fretboardEl.appendChild(cell);
                }
            }
        }

        function renderButtons() {
            const btnContainer = document.getElementById('note-buttons');
            btnContainer.innerHTML = '';
            notes.forEach(note => {
                const btn = document.createElement('button');
                btn.textContent = note;
                btn.className = 'note-btn';
                btn.onclick = () => checkAnswer(note);
                btnContainer.appendChild(btn);
            });
        }

        function getNoteAt(stringIdx, fretIdx) {
            const openNote = stringTuning[stringIdx];
            const openNoteIdx = notes.indexOf(openNote);
            const targetIdx = (openNoteIdx + fretIdx) % 12;
            return notes[targetIdx];
        }

        function generateQuestion() {
            isWaiting = false;
            feedbackEl.textContent = '';
            nextBtn.style.display = 'none';

            const oldDot = document.querySelector('.target-dot');
            if (oldDot) oldDot.remove();

            let targetStringIndex;
            const selectedStringVal = stringSelector.value;
            
            if (selectedStringVal === 'all') {
                targetStringIndex = Math.floor(Math.random() * numStrings);
            } else {
                targetStringIndex = parseInt(selectedStringVal);
            }

            let availableFrets = [];
            if (modeSwitch.checked) {
                availableFrets = inlays;
            } else {
                availableFrets = Array.from({length: numFrets + 1}, (_, i) => i);
            }

            const randFret = availableFrets[Math.floor(Math.random() * availableFrets.length)];


            currentTarget.stringIdx = targetStringIndex;
            currentTarget.fretIdx = randFret;
            currentTarget.note = getNoteAt(targetStringIndex, randFret);

            const cell = document.querySelector(`.fret-cell[data-string="${targetStringIndex}"][data-fret="${randFret}"]`);
            if (cell) {
                const dot = document.createElement('div');
                dot.className = 'target-dot';
                cell.appendChild(dot);
                
  
            }
        }

        function checkAnswer(selectedNote) {
            if (isWaiting) return;

            totalCount++;
            document.getElementById('score-total').textContent = totalCount;
            const isCorrect = (selectedNote === currentTarget.note);

            if (isCorrect) {
                correctCount++;
                document.getElementById('score-correct').textContent = correctCount;
                feedbackEl.innerHTML = `<span style="color:var(--correct)">✔ ${selectedNote}</span>`;
                isWaiting = true;
                setTimeout(generateQuestion, 500); 
            } else {
                let displayNote = notesDisplay[currentTarget.note] ? `${currentTarget.note}/${notesDisplay[currentTarget.note]}` : currentTarget.note;
                feedbackEl.innerHTML = `<span style="color:var(--wrong)">✘ ${displayNote}</span>`;
                isWaiting = true;
                nextBtn.style.display = 'block';
            }
        }

        init();
    </script>
</body>
</html>
